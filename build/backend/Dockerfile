FROM golang:1.12 as backend

WORKDIR /go/src/github.com/thertype/prom-rule/cmd/alert-gateway

COPY cmd/alert-gateway .

COPY go.mod /go/src/github.com/thertype/prom-rule

COPY go.sum /go/src/github.com/thertype/prom-rule

RUN export GO111MODULE=on && \
    export GOPROXY=https://goproxy.cn && \
    go build main.go && \
    mv main doraemon && \
    tar cvf pack.tar doraemon conf/

FROM 360cloud/centos:7

RUN ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime

COPY --from=backend /go/src/github.com/thertype/prom-rule/cmd/alert-gateway/pack.tar /opt/doraemon/

WORKDIR /opt/doraemon/

RUN tar -xvf pack.tar

CMD ["./doraemon"]
